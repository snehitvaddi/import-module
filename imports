import os
import json

def reformat_all_cluster_files(folder_path):
    expected_columns = [
        'ArticleNumber', 'CHANNELS', 'Title', 'BW_Article_Details_c',
        'Last_Published_Date', 'highlight_chunk', 'version_number',
        'final_sim_score', 'ROLES', 'URL'
    ]
    
    files_processed = 0
    for filename in os.listdir(folder_path):
        if filename.startswith("Batch_rebalanced_") and filename.endswith(".json"):
            file_path = os.path.join(folder_path, filename)
            print(f"Processing {filename}...")
            
            # Create a temporary file path
            temp_file = file_path + ".temp"
            
            try:
                # Read the JSON file
                with open(file_path, 'r', encoding='utf-8') as f:
                    try:
                        data = json.load(f)
                        if isinstance(data, dict):
                            data = [data]  # Convert single JSON object to list
                    except json.JSONDecodeError:
                        print(f"  ERROR: {filename} is not a valid JSON file. Skipping.")
                        continue
                
                # Reformat each record
                reformatted_data = []
                for record in data:
                    if not isinstance(record, dict):
                        print(f"  ERROR: Record is not a dictionary. Skipping.")
                        continue
                    
                    fixed_record = {}
                    for key, value in record.items():
                        clean_key = key.replace('\\', '').replace('\"', '')
                        fixed_record[clean_key] = value
                    
                    ordered_record = {}
                    
                    # Add expected columns in order (if they exist)
                    for col in expected_columns:
                        if col in fixed_record:
                            ordered_record[col] = fixed_record[col]
                    
                    # Add any remaining columns
                    for key, value in fixed_record.items():
                        if key not in ordered_record:
                            ordered_record[key] = value
                    
                    reformatted_data.append(ordered_record)
                
                # Write to temporary file first
                with open(temp_file, 'w', encoding='utf-8') as f:
                    json.dump(reformatted_data, f, indent=2, ensure_ascii=False)
                
                # Verify temp file was written successfully
                if os.path.exists(temp_file) and os.path.getsize(temp_file) > 0:
                    # On Windows, we need to remove the destination file first
                    if os.path.exists(file_path):
                        os.remove(file_path)
                    
                    # Rename the temp file to the original name
                    os.rename(temp_file, file_path)
                    
                    files_processed += 1
                    print(f"  SUCCESS: Reformatted {filename}")
                else:
                    print(f"  ERROR: Failed to write temporary file")
                    
            except Exception as e:
                print(f"  ERROR: Failed to process {filename}: {e}")
                
                # Clean up temp file if it exists
                if os.path.exists(temp_file):
                    try:
                        os.remove(temp_file)
                    except:
                        pass
    
    print(f"Reformatting complete: {files_processed} files processed")

# Update this path to your actual folder
output_folder = ""
reformat_all_cluster_files(output_folder)
